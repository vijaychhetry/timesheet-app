<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Timesheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            padding: 2rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.3s ease-in-out;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <div class="container bg-white shadow-xl rounded-2xl p-6 lg:p-10 border border-gray-200">
        <!-- User ID display -->
        <div class="mb-4 text-center text-sm text-gray-500">
            <span class="font-semibold">Your User ID:</span> <span id="user-id">Loading...</span>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Daily Timesheet</h1>

        <!-- Form for adding new entries -->
        <div class="p-4 md:p-6 bg-gray-50 rounded-xl mb-8 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Add New Entry</h2>
            <form id="timesheet-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-2">
                    <label for="task-name" class="block text-sm font-medium text-gray-600 mb-1">Task / Activity</label>
                    <input type="text" id="task-name" class="w-full p-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="entry-type" class="block text-sm font-medium text-gray-600 mb-1">Type</label>
                    <select id="entry-type" class="w-full p-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="Work">Work</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Break">Break</option>
                    </select>
                </div>
                <div>
                    <label for="start-time" class="block text-sm font-medium text-gray-600 mb-1">Start Time</label>
                    <input type="time" id="start-time" class="w-full p-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="end-time" class="block text-sm font-medium text-gray-600 mb-1">End Time</label>
                    <input type="time" id="end-time" class="w-full p-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="md:col-span-5 flex justify-end">
                    <button type="submit" class="w-full md:w-auto px-6 py-2.5 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors shadow-md">Add Entry</button>
                </div>
            </form>
        </div>

        <!-- Gemini API section -->
        <div class="p-4 md:p-6 bg-gray-50 rounded-xl mb-8 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">✨ Generate Tasks with AI ✨</h2>
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <input type="text" id="goal-input" placeholder="e.g., Prepare for client meeting" class="flex-grow p-2.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <button id="generate-btn" class="w-full md:w-auto px-6 py-2.5 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition-colors shadow-md">Generate Tasks</button>
            </div>
            <div id="loading-indicator" class="hidden flex justify-center items-center py-4">
                <div class="loading-spinner"></div>
                <span class="ml-3 text-gray-500">Generating your tasks...</span>
            </div>
            <div id="generated-tasks" class="space-y-4">
                <!-- Generated tasks will be inserted here -->
            </div>
        </div>

        <!-- Timesheet Table -->
        <div class="overflow-x-auto mb-8">
            <table class="w-full text-left table-auto">
                <thead>
                    <tr class="bg-gray-100 text-gray-600">
                        <th class="py-3 px-4 font-semibold text-sm rounded-tl-lg">Type</th>
                        <th class="py-3 px-4 font-semibold text-sm">Task / Activity</th>
                        <th class="py-3 px-4 font-semibold text-sm">Start</th>
                        <th class="py-3 px-4 font-semibold text-sm">End</th>
                        <th class="py-3 px-4 font-semibold text-sm">Duration</th>
                        <th class="py-3 px-4 font-semibold text-sm rounded-tr-lg text-right">Action</th>
                    </tr>
                </thead>
                <tbody id="timesheet-body" class="bg-white">
                    <!-- Timesheet entries will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Summary section -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
            <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-200">
                <p class="text-sm font-medium text-indigo-700">Total Time in Office</p>
                <p id="total-office-time" class="text-2xl font-bold text-indigo-900 mt-1">0h 0m</p>
            </div>
            <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                <p class="text-sm font-medium text-green-700">Total Work Hours</p>
                <p id="total-work-time" class="text-2xl font-bold text-green-900 mt-1">0h 0m</p>
            </div>
            <div class="bg-rose-50 rounded-xl p-4 border border-rose-200">
                <p class="text-sm font-medium text-rose-700">Total Break Time</p>
                <p id="total-break-time" class="text-2xl font-bold text-rose-900 mt-1">0h 0m</p>
            </div>
            <div class="bg-sky-50 rounded-xl p-4 border border-sky-200">
                <p class="text-sm font-medium text-sky-700">Total Meetings</p>
                <p id="total-meeting-time" class="text-2xl font-bold text-sky-900 mt-1">0h 0m</p>
            </div>
        </div>

        <!-- Action buttons -->
        <div class="mt-8 flex flex-col md:flex-row justify-center gap-4">
            <button id="export-csv-btn" class="px-6 py-2.5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors shadow-md">Export as CSV</button>
            <button id="how-to-sheets-btn" class="px-6 py-2.5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors shadow-md">How to use with Google Sheets</button>
            <button id="clear-all-btn" class="px-6 py-2.5 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors shadow-md">Clear All</button>
        </div>

    </div>
    
    <!-- How-To Modal -->
    <div id="sheets-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Using Your Timesheet with Google Sheets</h3>
        <ol class="list-decimal list-inside space-y-3 text-gray-700">
            <li>Click the **Export as CSV** button below. This downloads a file named `timesheet.csv`.</li>
            <li>Open a new or existing spreadsheet in Google Sheets.</li>
            <li>Go to the **File** menu, then select **Import**.</li>
            <li>In the pop-up, choose the **Upload** tab.</li>
            <li>Drag and drop your `timesheet.csv` file into the upload box.</li>
            <li>Click **Import data** to bring your timesheet entries into the sheet.</li>
        </ol>
        <p class="mt-4 text-sm text-gray-500">This is the most secure and reliable way to transfer your data.</p>
      </div>
    </div>

    <!-- Clear All Confirmation Modal -->
    <div id="clear-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn clear-modal-close">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p class="text-gray-700 mb-6">This will permanently delete all timesheet entries. This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-clear-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="confirm-clear-btn" class="px-4 py-2 bg-rose-600 text-white font-medium rounded-lg hover:bg-rose-700 transition-colors">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase with global configs
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
                                  apiKey: "AIzaSyDwY_s1U2EPnZJcJVYozd8ykGva6SjbJ5A",
                                  authDomain: "timesheetapp-vj.firebaseapp.com",
                                  projectId: "timesheetapp-vj",
                                  storageBucket: "timesheetapp-vj.firebasestorage.app",
                                  messagingSenderId: "141050414099",
                                  appId: "1:141050414099:web:efd3e76e6ff22c34a3abe6",
                                  measurementId: "G-GDN3M7J2KX"
                                };
        // const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                    // You will also need to handle user authentication yourself
            // For this app, anonymous sign-in is a good option for simplicity
            const initialAuthToken = null; // This is not needed for anonymous auth
            
            let db, auth;
            let userId = null;
            let entries = [];


        const userIdEl = document.getElementById('user-id');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const howToSheetsBtn = document.getElementById('how-to-sheets-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const timesheetForm = document.getElementById('timesheet-form');
        const generateBtn = document.getElementById('generate-btn');
        const sheetsModal = document.getElementById('sheets-modal');
        const clearModal = document.getElementById('clear-modal');
        const closeBtnSheets = document.querySelector('.modal #sheets-modal .close-btn');
        const closeBtnClear = document.querySelector('.modal #clear-modal .close-btn');
        const confirmClearBtn = document.getElementById('confirm-clear-btn');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');

        let unsubscribeFromFirestore = null;

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate the user and set up the listener for auth state changes
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Use onAuthStateChanged to ensure the user is fully authenticated before proceeding
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = userId;
                        console.log("Firebase authenticated. User ID:", userId);
                        setupFirestoreListener();
                    } else {
                        console.error("User is not authenticated.");
                        userIdEl.textContent = "Auth Error!";
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                userIdEl.textContent = "Auth Error!";
            }
        };

        // --- Firestore Listener Setup ---
        const setupFirestoreListener = () => {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore(); // Detach any existing listener
            }
            const timesheetRef = collection(db, `artifacts/${appId}/users/${userId}/timesheet`);
            
            // onSnapshot sets up a real-time listener to the collection
            unsubscribeFromFirestore = onSnapshot(timesheetRef, (snapshot) => {
                entries = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    entries.push({ id: doc.id, ...data });
                });
                
                // Sort entries by start time to ensure correct total office time calculation
                entries.sort((a, b) => a.startTime - b.startTime);
                renderTimesheet();
            }, (error) => {
                console.error("Error listening to Firestore changes:", error);
            });
        };

        // --- Firestore Operations ---
        const addEntryToFirestore = async (entry) => {
            if (!db || !userId) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/timesheet`), {
                    ...entry,
                    startTime: entry.startTime.getTime(), // Convert Date to timestamp for storage
                    endTime: entry.endTime.getTime(),     // Convert Date to timestamp for storage
                    createdAt: serverTimestamp()          // Add a server-side timestamp
                });
            } catch (error) {
                console.error("Error adding document to Firestore:", error);
            }
        };

        const deleteEntryFromFirestore = async (docId) => {
            if (!db || !userId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/timesheet`, docId));
            } catch (error) {
                console.error("Error deleting document from Firestore:", error);
            }
        };

        const clearAllEntriesFromFirestore = async () => {
            if (!db || !userId) return;
            try {
                const timesheetRef = collection(db, `artifacts/${appId}/users/${userId}/timesheet`);
                const snapshot = await getDocs(timesheetRef);
                const deletePromises = [];
                snapshot.docs.forEach(d => {
                    deletePromises.push(deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/timesheet`, d.id)));
                });
                await Promise.all(deletePromises);
                console.log("All entries cleared successfully.");
            } catch (error) {
                console.error("Error clearing all entries:", error);
            }
        };
        
        // --- App Logic (Updated to use Firestore) ---
        const formatDuration = (ms) => {
            const totalMinutes = Math.floor(ms / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours}h ${minutes}m`;
        };

        const updateSummary = () => {
            let totalWorkMs = 0;
            let totalBreakMs = 0;
            let totalMeetingMs = 0;
            
            entries.forEach(entry => {
                const durationMs = entry.endTime - entry.startTime;
                if (entry.type === 'Work') {
                    totalWorkMs += durationMs;
                } else if (entry.type === 'Break') {
                    totalBreakMs += durationMs;
                } else if (entry.type === 'Meeting') {
                    totalMeetingMs += durationMs;
                }
            });
            
            const firstEntryTime = entries.length > 0 ? entries[0].startTime : null;
            const lastEntryTime = entries.length > 0 ? entries[entries.length - 1].endTime : null;
            const totalOfficeMs = firstEntryTime && lastEntryTime ? lastEntryTime - firstEntryTime : 0;
            
            document.getElementById('total-office-time').textContent = formatDuration(totalOfficeMs);
            document.getElementById('total-work-time').textContent = formatDuration(totalWorkMs);
            document.getElementById('total-break-time').textContent = formatDuration(totalBreakMs);
            document.getElementById('total-meeting-time').textContent = formatDuration(totalMeetingMs);
        };

        const renderTimesheet = () => {
            const timesheetBody = document.getElementById('timesheet-body');
            timesheetBody.innerHTML = '';
            
            entries.forEach(entry => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'last:border-b-0', 'text-gray-700', 'hover:bg-gray-50');
                
                const start = new Date(entry.startTime);
                const end = new Date(entry.endTime);
                const durationMs = end - start;
                const durationStr = formatDuration(durationMs);
                
                row.innerHTML = `
                    <td class="py-3 px-4 font-semibold">${entry.type}</td>
                    <td class="py-3 px-4">${entry.taskName}</td>
                    <td class="py-3 px-4">${start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="py-3 px-4">${end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="py-3 px-4">${durationStr}</td>
                    <td class="py-3 px-4 text-right">
                        <button class="delete-btn text-rose-500 hover:text-rose-700 transition-colors" data-doc-id="${entry.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                timesheetBody.appendChild(row);
            });
            updateSummary();
        };

        // --- Export to CSV Function ---
        const exportToCsv = () => {
            const headers = ["Type", "Task / Activity", "Start Time", "End Time", "Duration (minutes)"];
            
            // Format data for CSV
            const csvRows = [headers.join(',')];
            entries.forEach(entry => {
                const start = new Date(entry.startTime);
                const end = new Date(entry.endTime);
                const durationMinutes = Math.floor((end - start) / (1000 * 60));
                
                const row = [
                    `"${entry.type}"`,
                    `"${entry.taskName.replace(/"/g, '""')}"`, // Handle quotes in task name
                    `"${start.toLocaleDateString()} ${start.toLocaleTimeString()}"`,
                    `"${end.toLocaleDateString()} ${end.toLocaleTimeString()}"`,
                    durationMinutes
                ];
                csvRows.push(row.join(','));
            });

            // Create a Blob and URL to download the file
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "timesheet.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();

            timesheetForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const taskName = document.getElementById('task-name').value;
                const entryType = document.getElementById('entry-type').value;
                const startTimeInput = document.getElementById('start-time').value;
                const endTimeInput = document.getElementById('end-time').value;
                
                const today = new Date().toISOString().slice(0, 10);
                const startDateTime = new Date(`${today}T${startTimeInput}:00`);
                const endDateTime = new Date(`${today}T${endTimeInput}:00`);
                
                if (endDateTime <= startDateTime) {
                    console.error('End time must be after start time.');
                    return;
                }
                
                addEntryToFirestore({
                    taskName,
                    type: entryType,
                    startTime: startDateTime,
                    endTime: endDateTime
                });
                
                timesheetForm.reset();
            });

            document.getElementById('timesheet-body').addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) {
                    const docId = e.target.closest('.delete-btn').dataset.docId;
                    deleteEntryFromFirestore(docId);
                }
            });
            
            // Clear All button logic
            clearAllBtn.addEventListener('click', () => {
                clearModal.style.display = 'flex';
            });

            confirmClearBtn.addEventListener('click', () => {
                clearAllEntriesFromFirestore();
                clearModal.style.display = 'none';
            });

            cancelClearBtn.addEventListener('click', () => {
                clearModal.style.display = 'none';
            });

            
            exportCsvBtn.addEventListener('click', exportToCsv);
            
            // Show the sheets modal
            howToSheetsBtn.addEventListener('click', () => {
                sheetsModal.style.display = 'flex';
            });

            // Hide the sheets modal
            const hideModal = (modal) => {
                modal.style.display = 'none';
            };

            document.querySelector('#sheets-modal .close-btn').addEventListener('click', () => hideModal(sheetsModal));
            document.querySelector('#clear-modal .close-btn').addEventListener('click', () => hideModal(clearModal));


            window.addEventListener('click', (event) => {
                if (event.target == sheetsModal) {
                    hideModal(sheetsModal);
                }
                if (event.target == clearModal) {
                    hideModal(clearModal);
                }
            });

            // --- Gemini API Integration ---
            generateBtn.addEventListener('click', async () => {
                const goal = document.getElementById('goal-input').value;
                if (!goal) return;

                const loadingIndicator = document.getElementById('loading-indicator');
                const generatedTasksDiv = document.getElementById('generated-tasks');
                
                loadingIndicator.classList.remove('hidden');
                generatedTasksDiv.innerHTML = '';
                generateBtn.disabled = true;

                try {
                    const prompt = `Break down the following high-level goal into a series of actionable, time-based tasks suitable for a timesheet. For each task, provide an estimated duration in minutes. The output must be a JSON array of objects with the following schema: [{"taskName": "string", "type": "Work" | "Meeting", "durationMinutes": "number"}].
                    
                    Example goal: "Prepare for client meeting"
                    Example output:
                    [
                        {"taskName": "Review client brief", "type": "Work", "durationMinutes": 30},
                        {"taskName": "Research competitor products", "type": "Work", "durationMinutes": 45},
                        {"taskName": "Draft presentation slides", "type": "Work", "durationMinutes": 60},
                        {"taskName": "Internal sync-up with team", "type": "Meeting", "durationMinutes": 15}
                    ]

                    High-level goal: "${goal}"
                    `;

                    // Gemini API call configuration
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "taskName": { "type": "STRING" },
                                        "type": { "type": "STRING", "enum": ["Work", "Meeting", "Break"] },
                                        "durationMinutes": { "type": "NUMBER" }
                                    },
                                    "propertyOrdering": ["taskName", "type", "durationMinutes"]
                                }
                            }
                        }
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    const parsedTasks = JSON.parse(text);

                    displayGeneratedTasks(parsedTasks);

                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    generatedTasksDiv.innerHTML = `<p class="text-rose-600">Error generating tasks. Please try again.</p>`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                    generateBtn.disabled = false;
                }
            });

            const displayGeneratedTasks = (tasks) => {
                const generatedTasksDiv = document.getElementById('generated-tasks');
                generatedTasksDiv.innerHTML = '';
                if (tasks.length === 0) {
                    generatedTasksDiv.innerHTML = `<p class="text-gray-500">No tasks were generated. Please try a different goal.</p>`;
                    return;
                }
                
                tasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.classList.add('bg-white', 'p-4', 'rounded-lg', 'border', 'border-gray-200', 'flex', 'flex-col', 'md:flex-row', 'items-start', 'md:items-center', 'justify-between', 'gap-2');
                    
                    const duration = formatDuration(task.durationMinutes * 60 * 1000);

                    taskEl.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${task.taskName}</p>
                            <p class="text-sm text-gray-500">${task.type} &bull; Est. ${duration}</p>
                        </div>
                        <button class="add-generated-task-btn px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors shadow-sm whitespace-nowrap" 
                            data-task-name="${task.taskName}"
                            data-task-type="${task.type}"
                            data-duration-minutes="${task.durationMinutes}">
                            Add to Timesheet
                        </button>
                    `;
                    generatedTasksDiv.appendChild(taskEl);
                });
            };

            // Event listener for adding generated tasks
            document.getElementById('generated-tasks').addEventListener('click', (e) => {
                if (e.target.closest('.add-generated-task-btn')) {
                    const btn = e.target.closest('.add-generated-task-btn');
                    const taskName = btn.dataset.taskName;
                    const taskType = btn.dataset.taskType;
                    const durationMinutes = parseInt(btn.dataset.durationMinutes, 10);
                    
                    const now = new Date();
                    const end = new Date(now.getTime() + durationMinutes * 60 * 1000);

                    addEntryToFirestore({
                        taskName: taskName,
                        type: taskType,
                        startTime: now,
                        endTime: end
                    });
                }
            });
        });
    </script>
</body>
</html>
